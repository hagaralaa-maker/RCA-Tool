<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Analysis Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex h-screen bg-slate-50 font-sans text-slate-800">

    <!-- SIDEBAR -->
    <div class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-10 flex-shrink-0">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <i data-lucide="clipboard-check" class="text-blue-500"></i>
                QA Nexus
            </h1>
            <p class="text-xs text-slate-400 mt-1">Quality Analysis & CAPA Tool</p>
        </div>
        
        <nav class="flex-1 p-4 space-y-1" id="sidebar-nav">
            <button data-tab="dashboard" class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 bg-blue-600 text-white shadow-md">
                <div class="flex items-center gap-3"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard overview</div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-70 btn-indicator"></i>
            </button>
            <button data-tab="agents" class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                <div class="flex items-center gap-3"><i data-lucide="users" class="w-5 h-5"></i> Agent Performance</div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 btn-indicator"></i>
            </button>
            <button data-tab="errors" class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                <div class="flex items-center gap-3"><i data-lucide="alert-circle" class="w-5 h-5"></i> Error Trends</div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 btn-indicator"></i>
            </button>
            <button data-tab="5whys" class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                <div class="flex items-center gap-3"><i data-lucide="file-search" class="w-5 h-5"></i> 5 Whys Analysis</div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 btn-indicator"></i>
            </button>
            <button data-tab="capa" class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                <div class="flex items-center gap-3"><i data-lucide="clipboard-check" class="w-5 h-5"></i> Action Plans (CAPA)</div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 btn-indicator"></i>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button data-tab="data" class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-slate-200">
                <div class="flex items-center gap-3"><i data-lucide="database" class="w-5 h-5"></i> Data Source / Setup</div>
                <i data-lucide="chevron-right" class="w-4 h-4 opacity-0 btn-indicator"></i>
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
        
        <!-- HEADER -->
        <header class="bg-white px-8 py-5 border-b border-slate-200 flex justify-between items-center shadow-sm shrink-0">
            <div>
                <h2 id="header-title" class="text-2xl font-bold text-slate-800 capitalize">Dashboard Overview</h2>
                <p class="text-sm text-slate-500">Track, analyze, and improve multi-channel performance.</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-100 p-2 rounded-lg border border-slate-200">
                    <i data-lucide="calendar" class="w-4 h-4 text-slate-500"></i>
                    <select id="time-filter" class="bg-transparent border-none text-sm font-medium outline-none text-slate-700 cursor-pointer pr-4 focus:ring-0">
                        <option value="All">All Time</option>
                        <!-- Options generated in JS -->
                    </select>
                </div>
            </div>
        </header>

        <!-- SCROLLABLE CONTENT AREA -->
        <main class="flex-1 overflow-y-auto p-8 relative">
            
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-50 flex flex-col items-center justify-center hidden">
                <i data-lucide="loader-2" class="w-10 h-10 text-blue-500 animate-spin mb-4"></i>
                <p class="text-slate-700 font-medium" id="loading-text">Syncing with Supabase...</p>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content active space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-blue-500">
                        <div class="text-slate-500 text-sm font-medium mb-1">Average QA Score</div>
                        <div class="flex items-end gap-3">
                            <div class="text-3xl font-bold text-slate-800" id="kpi-avg-score">0%</div>
                            <div id="kpi-score-trend" class="flex items-center text-sm mb-1 font-medium"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-purple-500">
                        <div class="text-slate-500 text-sm font-medium mb-1">Total Audits</div>
                        <div class="text-3xl font-bold text-slate-800" id="kpi-total-audits">0</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-red-500">
                        <div class="text-slate-500 text-sm font-medium mb-1">Total Errors Found</div>
                        <div class="text-3xl font-bold text-slate-800" id="kpi-total-errors">0</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-amber-500">
                        <div class="text-slate-500 text-sm font-medium mb-1">Active Action Plans</div>
                        <div class="text-3xl font-bold text-slate-800" id="kpi-active-plans">0</div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-6 flex items-center gap-2"><i data-lucide="trending-up" class="w-5 h-5"></i> Performance Trends (YoY / MoM)</h3>
                        <div class="h-72 relative w-full">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                        <h3 class="text-lg font-semibold mb-6">Queue Performance</h3>
                        <div class="h-72 relative w-full">
                            <canvas id="queueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AGENTS TAB -->
            <div id="tab-agents" class="tab-content">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold">Agent Leaderboard & Breakdown</h3>
                        <div class="relative">
                            <i data-lucide="filter" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="agent-search" placeholder="Filter agents..." class="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-slate-500 text-sm uppercase tracking-wider border-y border-slate-200">
                                    <th class="p-4 font-semibold">Agent Name</th>
                                    <th class="p-4 font-semibold">Total Audits</th>
                                    <th class="p-4 font-semibold">Avg Score</th>
                                    <th class="p-4 font-semibold">Total Errors</th>
                                    <th class="p-4 font-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody id="agent-table-body" class="divide-y divide-slate-100">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ERRORS TAB -->
            <div id="tab-errors" class="tab-content space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="text-lg font-semibold mb-6 text-slate-800">Most Common QA Errors (By Attribute)</h3>
                    <div class="h-80 relative w-full">
                        <canvas id="errorChart"></canvas>
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 flex items-start gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-blue-500 mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-blue-900">AI Insight</h4>
                            <p class="text-sm text-blue-800 mt-1">
                                <strong id="top-error-name">No Data</strong> is consistently your highest failure point. Navigate to the 5 Whys Analysis tab to select this attribute and generate an AI Root Cause analysis.
                            </p>
                            <button onclick="switchTab('5whys')" class="mt-3 text-sm bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700 transition-colors">
                                View 5 Whys Actions
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5 WHYS TAB -->
            <div id="tab-5whys" class="tab-content space-y-6">
                
                <div class="flex justify-between items-center">
                    <p class="text-slate-600">Conduct deep-dive root cause analysis for recurring quality failures.</p>
                    <button onclick="openNewAnalysisModal()" class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Manual Analysis
                    </button>
                </div>
                
                <!-- Target-Based AI Generation Control Panel -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-5 flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-sm font-medium text-blue-900 mb-1">Target Type</label>
                        <select id="ai-target-type" onchange="updateAITargetValues()" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="Attribute">Specific Attribute</option>
                            <option value="Agent">Specific Agent</option>
                            <option value="Queue">Specific Queue</option>
                        </select>
                    </div>
                    <div class="flex-1 w-full">
                        <label class="block text-sm font-medium text-blue-900 mb-1">Select Target</label>
                        <select id="ai-target-value" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="">Loading targets...</option>
                        </select>
                    </div>
                    <button onclick="runTargetedAI()" class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2 shrink-0 h-[38px]">
                        <i data-lucide="cpu" class="w-4 h-4"></i> Generate AI 5 Whys
                    </button>
                </div>

                <div id="five-whys-container" class="space-y-6">
                    <div class="text-center py-10 text-slate-500">
                        No 5 Whys data available. Sync data in the Data Setup tab to populate.
                    </div>
                </div>
            </div>

            <!-- CAPA TAB -->
            <div id="tab-capa" class="tab-content space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h3 class="text-lg font-semibold mb-6">Corrective & Preventive Action Plans</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 text-slate-500 text-sm uppercase tracking-wider border-y border-slate-200">
                                    <th class="p-4 font-semibold">Linked RC ID</th>
                                    <th class="p-4 font-semibold w-1/3">Action Defined</th>
                                    <th class="p-4 font-semibold">Type</th>
                                    <th class="p-4 font-semibold">Owner</th>
                                    <th class="p-4 font-semibold">Status</th>
                                </tr>
                            </thead>
                            <tbody id="capa-table-body" class="divide-y divide-slate-100">
                                <tr>
                                    <td colspan="5" class="p-4 text-center text-slate-500">No CAPA items found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- DATA TAB -->
            <div id="tab-data" class="tab-content max-w-3xl">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="database" class="w-6 h-6 text-blue-500"></i> Google Sheets API Integration</h2>
                    <p class="text-slate-600 mb-6 leading-relaxed">
                        Connect your Google Cloud project directly to automatically read and sync raw QA data to your Supabase database.
                    </p>

                    <div class="space-y-6">
                        <!-- Direct Google Sheets Sync -->
                        <div class="p-5 border border-blue-200 rounded-lg bg-blue-50/30">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="link" class="w-4 h-4 text-blue-500"></i> API Settings & Sync</h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Google Cloud API Key (with Sheets API enabled)</label>
                                    <input type="password" id="gsheet-api-key" placeholder="AIzaSyB..." class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Gemini API Key (For AI 5 Whys Automation)</label>
                                    <input type="password" id="gemini-api-key" placeholder="AIzaSy..." class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <p class="text-xs text-slate-500 mt-1">Get a free key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 underline hover:text-blue-700">Google AI Studio</a>.</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Google Sheet URL</label>
                                    <input type="url" id="gsheet-url" placeholder="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <p class="text-xs text-slate-500 mt-1">Make sure the sheet is shared so the API can read it.</p>
                                </div>

                                <div class="pt-2">
                                    <button onclick="syncFromGoogleSheet()" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm flex items-center justify-center gap-2 shrink-0">
                                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Sync Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Fallback File Upload -->
                        <div class="p-5 border border-slate-200 rounded-lg border-dashed">
                            <h3 class="font-bold text-slate-800 mb-2">Fallback: Manual Upload</h3>
                            <p class="text-sm text-slate-600 mb-4">If you prefer not to use the API, you can export it as an Excel (.xlsx) or CSV file and upload it manually.</p>
                            
                            <label for="file-upload" class="block border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition-colors cursor-pointer group">
                                <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-slate-400 mb-2 group-hover:scale-110 transition-transform group-hover:text-blue-500"></i>
                                <p class="text-sm font-medium text-slate-700">Click to upload or drag and drop your file here.</p>
                                <p class="text-xs text-slate-500 mt-1">Supported formats: .xlsx, .xls, .csv</p>
                                <input type="file" id="file-upload" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" />
                            </label>
                        </div>
                    </div>

                    <div class="p-5 border border-red-200 rounded-lg bg-red-50 mt-6">
                        <h3 class="font-bold text-red-800 mb-2 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> Danger Zone</h3>
                        <p class="text-sm text-red-600 mb-4">Permanently delete all QA Data and 5 Whys Analysis from your database. This action cannot be undone.</p>
                        <button onclick="openDeleteModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors shadow-sm">
                            Delete All Data
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- New 5 Whys Analysis Modal (Manual) -->
    <div id="new-analysis-modal" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden overflow-y-auto pt-10 pb-10">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="file-plus" class="text-blue-500 w-6 h-6"></i>
                New Manual 5 Whys Analysis
            </h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Error Focus</label>
                        <input type="text" id="na-attribute" placeholder="e.g., Responsiveness or Agent Name" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Owner (Assignee)</label>
                        <input type="text" id="na-owner" placeholder="Name" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Problem Statement</label>
                    <input type="text" id="na-problem" placeholder="Describe the failure clearly" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-3">
                    <h4 class="font-semibold text-slate-700 text-sm">The 5 Whys Progression</h4>
                    <input type="text" id="na-why1" placeholder="Why 1? (Required)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="na-why2" placeholder="Why 2?" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="na-why3" placeholder="Why 3?" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="na-why4" placeholder="Why 4? (Optional)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="na-why5" placeholder="Why 5? (Optional)" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Identified Root Cause</label>
                    <textarea id="na-rootcause" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Corrective Action</label>
                        <textarea id="na-corrective" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Preventive Action</label>
                        <textarea id="na-preventive" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                    <select id="na-status" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-200">
                <button onclick="closeNewAnalysisModal()" class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition-colors">Cancel</button>
                <button onclick="saveNewAnalysis()" class="px-4 py-2 bg-blue-600 text-white font-medium hover:bg-blue-700 rounded-lg transition-colors">Save Analysis</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="text-red-500 w-6 h-6"></i>
                Delete All Data?
            </h3>
            <p class="text-slate-600 mb-6">This action cannot be undone. It will permanently delete all QA records and 5 Whys analyses from your database.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition-colors">Cancel</button>
                <button onclick="executeDeleteAll()" class="px-4 py-2 bg-red-600 text-white font-medium hover:bg-red-700 rounded-lg transition-colors">Yes, Delete All</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- SUPABASE INITIALIZATION ---
        const supabaseUrl = 'https://dbnbfpbxyqldaakgnstc.supabase.co';
        
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // IMPORTANT: PASTE YOUR FULL ANON KEY FROM SUPABASE SETTINGS HERE:
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibmJmcGJ4eXFsZGFha2duc3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4Nzg3NTQsImV4cCI6MjA4NzQ1NDc1NH0.IVW-x8Gx0ACLFuZHMm9KEtaOPAHpy8AlCsEuYYapclw'; 
        
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- STATE & INITIALIZATION ---
        let qaData = [];
        let fiveWhysData = [];
        
        let currentTab = 'dashboard';
        let timeFilter = 'All';
        
        // Chart instances for destroying/recreating
        let trendChartInst = null;
        let queueChartInst = null;
        let errorChartInst = null;


        // --- AI GENERATOR (TARGETED MANUAL RUN) ---

        function updateAITargetValues() {
            const type = document.getElementById('ai-target-type').value;
            const valueSelect = document.getElementById('ai-target-value');
            valueSelect.innerHTML = '<option value="">Select an option...</option>';
            
            let options = new Set();
            
            qaData.forEach(d => {
                if (d.failedAttributes && d.failedAttributes.length > 0) {
                    if (type === 'Attribute') {
                        d.failedAttributes.forEach(attr => options.add(attr));
                    } else if (type === 'Agent') {
                        options.add(d.agent);
                    } else if (type === 'Queue') {
                        options.add(d.queue);
                    }
                }
            });
            
            Array.from(options).sort().forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                valueSelect.appendChild(el);
            });
        }

        async function runTargetedAI() {
            const type = document.getElementById('ai-target-type').value;
            const value = document.getElementById('ai-target-value').value;
            
            if (!value) return alert("Please select a specific target value to analyze.");

            // Get Gemini key from input when hosted on GitHub Pages
            const apiKey = document.getElementById('gemini-api-key').value.trim() || localStorage.getItem('qa_gemini_api_key'); 
            if (!apiKey) {
                alert("Please add your Gemini API Key in the Data Setup tab to use the AI features.");
                return switchTab('data');
            }

            // Gather all failed attributes related to this target
            let allFailedAttrs = new Set();

            qaData.forEach(row => {
                if (!row.failedAttributes || row.failedAttributes.length === 0) return;
                let match = false;
                if (type === 'Attribute' && row.failedAttributes.includes(value)) match = true;
                if (type === 'Agent' && row.agent === value) match = true;
                if (type === 'Queue' && row.queue === value) match = true;

                if (match) {
                    row.failedAttributes.forEach(a => allFailedAttrs.add(a));
                }
            });

            if (allFailedAttrs.size === 0) {
                return alert("No failures found for this selection to analyze.");
            }

            const promptText = `Perform a systemic 5 Whys root cause analysis for customer service QA failures. 
            Focus area: ${type} = "${value}". 
            The following attributes failed across multiple audits in this focus area: ${Array.from(allFailedAttrs).join(', ')}.
            Generate a realistic, generalized 5 Whys root cause analysis exploring why this specific ${type.toLowerCase()} might be experiencing these failures. Return the output STRICTLY as a JSON object matching this schema.`;

            const payload = {
                contents: [{ parts: [{ text: promptText }] }],
                systemInstruction: { parts: [{ text: "You are an expert Quality Assurance and Process Improvement analyst. Perform a logical 5 Whys root cause analysis based on the provided focus area. Do not use formatting outside of the requested JSON." }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            problemStatement: { type: "STRING", description: "A clear statement of the problem being analyzed." },
                            whys: { type: "ARRAY", items: { type: "STRING" }, description: "Array of exactly 5 'Why' statements logically progressing to the root cause." },
                            rootCause: { type: "STRING" },
                            correctiveAction: { type: "STRING", description: "Immediate action to fix the specific instance." },
                            preventiveAction: { type: "STRING", description: "Systemic action to prevent it from happening again." }
                        },
                        required: ["problemStatement", "whys", "rootCause", "correctiveAction", "preventiveAction"]
                    }
                }
            };

            showLoading(true, `Generating AI Analysis for ${value}...`);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                
                const result = await response.json();
                let text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
                    const aiResult = JSON.parse(text);

                    const newAnalysis = {
                        id: `RC-AI-${Date.now()}`,
                        date: new Date().toISOString().split('T')[0],
                        errorAttribute: `${type}: ${value}`,
                        problemStatement: aiResult.problemStatement || `Systemic failures related to ${value}`,
                        whys: aiResult.whys || [],
                        rootCause: aiResult.rootCause || 'Undetermined',
                        correctiveAction: aiResult.correctiveAction || '',
                        preventiveAction: aiResult.preventiveAction || '',
                        owner: 'AI Generated',
                        status: 'In Progress'
                    };

                    const { error } = await supabaseClient.from('five_whys').upsert([newAnalysis]);
                    if (error) throw error;
                    
                    fiveWhysData.push(newAnalysis);
                    render5Whys();
                    renderCapa();
                    renderDashboard(getFilteredData());
                    
                    alert("AI Analysis generated and saved successfully!");

                } else {
                    throw new Error("Empty response from AI");
                }
            } catch (error) {
                console.error("AI Generation failed:", error);
                alert("Failed to generate AI analysis. Check your Gemini API Key and try again.");
            } finally {
                showLoading(false);
            }
        }

        // --- CORE FUNCTIONS ---

        function openNewAnalysisModal() {
            document.getElementById('na-attribute').value = '';
            document.getElementById('na-owner').value = '';
            document.getElementById('na-problem').value = '';
            document.getElementById('na-why1').value = '';
            document.getElementById('na-why2').value = '';
            document.getElementById('na-why3').value = '';
            document.getElementById('na-why4').value = '';
            document.getElementById('na-why5').value = '';
            document.getElementById('na-rootcause').value = '';
            document.getElementById('na-corrective').value = '';
            document.getElementById('na-preventive').value = '';
            document.getElementById('na-status').value = 'In Progress';
            
            document.getElementById('new-analysis-modal').classList.remove('hidden');
        }

        function closeNewAnalysisModal() {
            document.getElementById('new-analysis-modal').classList.add('hidden');
        }

        async function saveNewAnalysis() {
            const why1 = document.getElementById('na-why1').value;
            const problem = document.getElementById('na-problem').value;
            const rootCause = document.getElementById('na-rootcause').value;

            if (!problem || !why1 || !rootCause) {
                alert('Please provide at least a Problem Statement, Why 1, and a Root Cause to save.');
                return;
            }

            showLoading(true, "Saving Analysis...");
            
            const newAnalysis = {
                id: `RC-${Date.now()}`,
                date: new Date().toISOString().split('T')[0],
                errorAttribute: document.getElementById('na-attribute').value || 'Unknown',
                problemStatement: problem,
                whys: [
                    why1,
                    document.getElementById('na-why2').value,
                    document.getElementById('na-why3').value,
                    document.getElementById('na-why4').value,
                    document.getElementById('na-why5').value
                ].filter(Boolean),
                rootCause: rootCause,
                correctiveAction: document.getElementById('na-corrective').value,
                preventiveAction: document.getElementById('na-preventive').value,
                owner: document.getElementById('na-owner').value || 'Unassigned',
                status: document.getElementById('na-status').value
            };

            try {
                const { error } = await supabaseClient.from('five_whys').upsert([newAnalysis]);
                if (error) throw error;
                
                fiveWhysData.push(newAnalysis);
                render5Whys();
                renderCapa();
                renderDashboard(getFilteredData()); 
                closeNewAnalysisModal();
            } catch (error) {
                console.error("Error saving analysis:", error);
                alert("Failed to save analysis. Please ensure you are connected to Supabase.");
            } finally {
                showLoading(false);
            }
        }
        
        function openDeleteModal() {
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        async function executeDeleteAll() {
            closeDeleteModal();
            showLoading(true, "Deleting all data from Supabase...");

            try {
                const { error: qaError } = await supabaseClient.from('qa_data').delete().neq('id', 'dummy_nonexistent_id');
                if (qaError) throw qaError;

                const { error: whysError } = await supabaseClient.from('five_whys').delete().neq('id', 'dummy_nonexistent_id');
                if (whysError) throw whysError;

                qaData = [];
                fiveWhysData = [];
                timeFilter = 'All';

                populateFilters();
                renderAll();
                
                showLoading(true, "Data deleted successfully!");
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Delete Error:", error);
                showLoading(true, "Error deleting data.");
                setTimeout(() => showLoading(false), 3000);
            }
        }

        function showLoading(show, text="Syncing with Supabase...") {
            const overlay = document.getElementById('loading-overlay');
            const loadText = document.getElementById('loading-text');
            if (show) {
                loadText.textContent = text;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        async function loadDataFromSupabase() {
            showLoading(true, "Loading Dashboard Data...");
            try {
                const { data: qa, error: qaError } = await supabaseClient.from('qa_data').select('*');
                if (qaError) throw qaError;
                if (qa) qaData = qa.filter(item => item.agent.toLowerCase() !== 'mohamed halim');

                const { data: whys, error: whysError } = await supabaseClient.from('five_whys').select('*');
                if (whysError) throw whysError;
                if (whys) fiveWhysData = whys;

                populateFilters();
                updateAITargetValues();
                renderAll();
            } catch (error) {
                console.error("Error loading data from Supabase:", error);
            } finally {
                showLoading(false);
            }
        }

        function getFilteredData() {
            if (timeFilter === 'All') return qaData;
            if (timeFilter.startsWith('Q')) return qaData.filter(d => d.quarter === timeFilter);
            if (timeFilter.length === 4) return qaData.filter(d => d.year === timeFilter);
            return qaData.filter(d => d.month === timeFilter);
        }

        function populateFilters() {
            const select = document.getElementById('time-filter');
            select.innerHTML = '<option value="All">All Time</option>';
            
            if (qaData.length === 0) return;

            const years = [...new Set(qaData.map(d => d.year))];
            const quarters = [...new Set(qaData.map(d => d.quarter))];
            const months = [...new Set(qaData.map(d => d.month))];
            
            const options = [...years, ...quarters, ...months];
            
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        function setupTabs() {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            document.getElementById('agent-search').addEventListener('input', renderAgents);
            
            document.getElementById('time-filter').addEventListener('change', (e) => {
                timeFilter = e.target.value;
                renderAll();
            });

            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
        }

        async function syncFromGoogleSheet(isAutoSync = false) {
            let urlInput = document.getElementById('gsheet-url').value;
            let apiKeyInput = document.getElementById('gsheet-api-key').value;
            let geminiKeyInput = document.getElementById('gemini-api-key').value;
            
            if (isAutoSync) {
                if (!urlInput) urlInput = localStorage.getItem('qa_gsheet_url');
                if (!apiKeyInput) apiKeyInput = localStorage.getItem('qa_gsheet_api_key');
                if (!geminiKeyInput) geminiKeyInput = localStorage.getItem('qa_gemini_api_key');
                
                if (urlInput) document.getElementById('gsheet-url').value = urlInput;
                if (apiKeyInput) document.getElementById('gsheet-api-key').value = apiKeyInput;
                if (geminiKeyInput) document.getElementById('gemini-api-key').value = geminiKeyInput;
            }

            if (!urlInput || !apiKeyInput) {
                if (!isAutoSync) alert("Please enter both a Google Sheets URL and a valid Google API Key.");
                return;
            }

            const idMatch = urlInput.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!idMatch) {
                if (!isAutoSync) alert("Invalid Google Sheets URL. Please make sure it looks like https://docs.google.com/spreadsheets/d/YOUR_ID/edit");
                return;
            }
            
            const sheetId = idMatch[1];
            
            // Save to localStorage for future automatic syncs
            localStorage.setItem('qa_gsheet_url', urlInput);
            localStorage.setItem('qa_gsheet_api_key', apiKeyInput);
            localStorage.setItem('qa_gemini_api_key', geminiKeyInput);

            if (!isAutoSync) showLoading(true, "Fetching data via Google Sheets API...");

            try {
                // 1. Get Spreadsheet metadata to find the exact name of the first sheet
                const metaRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?key=${apiKeyInput}`);
                if (!metaRes.ok) throw new Error("Could not access the Google Sheet. Check your API Key and ensure the sheet is shared.");
                const metaJson = await metaRes.json();
                const firstSheetTitle = metaJson.sheets[0].properties.title;

                // 2. Fetch the actual data values from the first sheet
                const dataRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(firstSheetTitle)}!A:ZZ?key=${apiKeyInput}`);
                if (!dataRes.ok) throw new Error("Failed to fetch sheet data values.");
                const dataJson = await dataRes.json();

                if (!dataJson.values || dataJson.values.length === 0) {
                    throw new Error("No data found in the sheet.");
                }

                // Convert 2D Array into Array of Objects
                const headers = dataJson.values[0];
                const qaParsedJson = [];
                for (let i = 1; i < dataJson.values.length; i++) {
                    // CRITICAL FIX: Skip completely empty rows that cause duplicate ID issues and wrong row counts
                    if (!dataJson.values[i] || dataJson.values[i].length === 0) continue;
                    
                    let rowObj = {};
                    let hasRealData = false;
                    for (let j = 0; j < headers.length; j++) {
                        let val = dataJson.values[i][j];
                        if (val !== undefined && String(val).trim() !== '') {
                            hasRealData = true;
                        }
                        rowObj[headers[j]] = val || '';
                    }
                    if(hasRealData) {
                        qaParsedJson.push(rowObj);
                    }
                }

                await processAndUploadToSupabase(qaParsedJson, [], isAutoSync);

            } catch (error) {
                console.error("Google Sheets API Error:", error);
                if (!isAutoSync) alert("Google Sheets Sync Error: " + error.message);
                if (!isAutoSync) showLoading(false);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading(true, "Processing local file...");

            const reader = new FileReader();
            reader.onload = async function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rawQaJson = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Filter empty rows
                    const qaJson = rawQaJson.filter(row => Object.values(row).some(v => v !== null && String(v).trim() !== ''));

                    const whysSheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('whys'));
                    let whysJson = [];
                    if (whysSheetName) {
                        const whysSheet = workbook.Sheets[whysSheetName];
                        const rawWhysJson = XLSX.utils.sheet_to_json(whysSheet);
                        whysJson = rawWhysJson.filter(row => Object.values(row).some(v => v !== null && String(v).trim() !== ''));
                    }

                    await processAndUploadToSupabase(qaJson, whysJson, false);
                    e.target.value = ""; 

                } catch (err) {
                    console.error("File Parse Error:", err);
                    alert("Error processing local file: " + err.message);
                    showLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function processAndUploadToSupabase(qaJson, whysJson, isAutoSync) {
            if (!isAutoSync) showLoading(true, "Uploading transformed data to Supabase...");
            
            try {
                const newQaData = qaJson.map((row, index) => {
                    let dRaw = row['created_at'] || row['date_created'] || row['Date'] || row['date'] || new Date().toISOString();
                    let d;
                    if (typeof dRaw === 'number') {
                         d = new Date((dRaw - (25567 + 2)) * 86400 * 1000);
                    } else {
                         d = new Date(dRaw);
                    }
                    if (isNaN(d.getTime())) d = new Date(); 
                    
                    let failedAttrs = [];

                    if (row['Failed Attributes']) {
                        failedAttrs = String(row['Failed Attributes']).split(',').map(s => s.trim()).filter(s => s);
                    } else {
                        const attributesToCheck = [
                            'Correctly_Diagnose', 'responsiveness', 'effectiveness', 'soft_Skills',
                            'language', 'FCR', 'ownership', 'product_Awareness', 'tempo_Values',
                            'process_Awareness', 'verification', 'documentations', 'crm_update',
                            'workflow', 'Interaction_Protocols',
                            'Brand_Representation_Ownership', 'comm_Brand_Representation_Ownership'
                        ];
                        
                        attributesToCheck.forEach(attr => {
                            if (row[attr] && String(row[attr]).trim().toLowerCase() === 'no') {
                                const formattedAttr = attr.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                failedAttrs.push(formattedAttr);
                            }
                        });
                    }

                    let rawScore = row['Final_Score'] || row['Score'];
                    let scoreVal = 0;
                    if (typeof rawScore === 'string') {
                        scoreVal = Number(rawScore.replace('%', '').trim());
                    } else if (typeof rawScore === 'number') {
                        scoreVal = rawScore <= 1 && rawScore > 0 ? Math.round(rawScore * 100) : rawScore;
                    }

                    const qaId = String(row['id'] || row['ID'] || `QA-${d.getTime()}-${index}`);
                    const agentName = String(row['Agent_Name'] || row['Agent'] || 'Unknown Agent');

                    return {
                        id: qaId,
                        date: d.toISOString().split('T')[0],
                        month: d.toLocaleString('default', { month: 'short', year: 'numeric' }),
                        quarter: `Q${Math.floor(d.getMonth() / 3) + 1} ${d.getFullYear()}`,
                        year: d.getFullYear().toString(),
                        agent: agentName,
                        queue: String(row['Channel'] || row['Queue'] || 'Unknown Queue'),
                        score: scoreVal || 0,
                        failedAttributes: failedAttrs
                    };
                }).filter(item => item.agent.toLowerCase() !== 'mohamed halim'); 
                
                let newFiveWhysData = whysJson.map((row, index) => ({
                    id: String(row['ID'] || `RC-${Date.now()}-${index}`),
                    date: String(row['Date'] || new Date().toISOString().split('T')[0]),
                    errorAttribute: String(row['Error Attribute'] || 'Unknown'),
                    problemStatement: String(row['Problem Statement'] || ''),
                    whys: [row['Why 1'], row['Why 2'], row['Why 3'], row['Why 4'], row['Why 5']].filter(Boolean),
                    rootCause: String(row['Root Cause'] || ''),
                    correctiveAction: String(row['Corrective Action'] || ''),
                    preventiveAction: String(row['Preventive Action'] || ''),
                    owner: String(row['Owner'] || 'Unassigned'),
                    status: String(row['Status'] || 'In Progress')
                }));

                // FIX FOR DUPLICATES: Deduplicate rows by ID before Upserting to prevent ON CONFLICT errors
                const uniqueQaData = Array.from(new Map(newQaData.map(item => [item.id, item])).values());
                const uniqueWhysData = Array.from(new Map(newFiveWhysData.map(item => [item.id, item])).values());

                if (uniqueQaData.length > 0) {
                    const { error: insertError } = await supabaseClient.from('qa_data').upsert(uniqueQaData);
                    if (insertError) throw insertError;
                }

                if (uniqueWhysData.length > 0) {
                    const { error: insertWhyError } = await supabaseClient.from('five_whys').upsert(uniqueWhysData);
                    if (insertWhyError) throw insertWhyError;
                }

                if (!isAutoSync) alert(`Success! Data synchronized to Supabase.`);
                timeFilter = 'All'; 
                
                await loadDataFromSupabase();
                if (!isAutoSync) switchTab('dashboard'); 

            } catch (err) {
                console.error("Upload/Processing Error:", err);
                if (!isAutoSync) alert("Error processing or uploading data: " + err.message);
                if (!isAutoSync) showLoading(false);
            }
        }

        function switchTab(tabId) {
            currentTab = tabId;
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const indicator = btn.querySelector('.btn-indicator');
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.remove('text-slate-400', 'hover:bg-slate-800', 'hover:text-slate-200');
                    indicator.classList.remove('opacity-0');
                    indicator.classList.add('opacity-70');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('text-slate-400', 'hover:bg-slate-800', 'hover:text-slate-200');
                    indicator.classList.remove('opacity-70');
                    indicator.classList.add('opacity-0');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            let titleText = tabId.replace(/([A-Z])/g, ' $1').trim();
            if (tabId === '5whys') titleText = '5 Whys Root Cause';
            if (tabId === 'capa') titleText = 'Action Plans (CAPA)';
            document.getElementById('header-title').textContent = titleText.charAt(0).toUpperCase() + titleText.slice(1);

            if (tabId === 'dashboard' || tabId === 'errors') {
                renderAll();
            }
        }

        // --- RENDERING LOGIC ---

        function renderAll() {
            const filtered = getFilteredData();
            renderDashboard(filtered);
            renderAgents(filtered);
            renderErrors(filtered);
            render5Whys();
            renderCapa();
        }

        function renderDashboard(filtered) {
            const totalScore = filtered.reduce((acc, curr) => acc + curr.score, 0);
            const avgScore = filtered.length ? Math.round(totalScore / filtered.length) : 0;
            const totalErrors = filtered.reduce((acc, curr) => acc + curr.failedAttributes?.length || 0, 0);
            const activePlans = fiveWhysData.filter(d => d.status === 'In Progress').length;

            document.getElementById('kpi-avg-score').textContent = `${avgScore}%`;
            document.getElementById('kpi-total-audits').textContent = filtered.length;
            document.getElementById('kpi-total-errors').textContent = totalErrors;
            document.getElementById('kpi-active-plans').textContent = activePlans;

            const trendEl = document.getElementById('kpi-score-trend');
            if (avgScore >= 90) {
                trendEl.innerHTML = `<i data-lucide="trending-up" class="w-4 h-4 mr-1"></i> On Target`;
                trendEl.className = "flex items-center text-sm mb-1 font-medium text-green-600";
            } else if (avgScore > 0) {
                trendEl.innerHTML = `<i data-lucide="trending-down" class="w-4 h-4 mr-1"></i> Needs Focus`;
                trendEl.className = "flex items-center text-sm mb-1 font-medium text-amber-500";
            } else {
                trendEl.innerHTML = `No Data`;
                trendEl.className = "flex items-center text-sm mb-1 font-medium text-slate-500";
            }
            lucide.createIcons({ root: trendEl });

            if(currentTab !== 'dashboard') return;

            const monthlyStats = {};
            qaData.forEach(d => {
                if (!monthlyStats[d.month]) {
                    monthlyStats[d.month] = { month: d.month, totalScore: 0, count: 0, Phone: 0, Chat: 0, Email: 0, phoneCount: 0, chatCount: 0, emailCount: 0 };
                }
                monthlyStats[d.month].totalScore += d.score;
                monthlyStats[d.month].count += 1;
                if (monthlyStats[d.month][d.queue] !== undefined) {
                    monthlyStats[d.month][d.queue] += d.score;
                    monthlyStats[d.month][`${d.queue.toLowerCase()}Count`] += 1;
                }
            });

            const trendData = Object.values(monthlyStats).map(stat => ({
                month: stat.month,
                Overall: Math.round(stat.totalScore / stat.count),
                Phone: stat.phoneCount ? Math.round(stat.Phone / stat.phoneCount) : null,
                Chat: stat.chatCount ? Math.round(stat.Chat / stat.chatCount) : null,
                Email: stat.emailCount ? Math.round(stat.Email / stat.emailCount) : null,
            }));

            if (trendChartInst) trendChartInst.destroy();
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            trendChartInst = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.month),
                    datasets: [
                        { label: 'Overall', data: trendData.map(d => d.Overall), borderColor: '#3b82f6', borderWidth: 3, tension: 0.3, pointRadius: 4 },
                        { label: 'Phone', data: trendData.map(d => d.Phone), borderColor: '#8b5cf6', borderWidth: 2, borderDash: [5, 5], tension: 0.3, pointRadius: 0 },
                        { label: 'Chat', data: trendData.map(d => d.Chat), borderColor: '#10b981', borderWidth: 2, borderDash: [5, 5], tension: 0.3, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, grid: { borderDash: [3, 3] }, border: {display: false} },
                        x: { grid: { display: false }, border: {display: false} }
                    },
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            const queues = {};
            filtered.forEach(d => {
                if (!queues[d.queue]) queues[d.queue] = { total: 0, count: 0 };
                queues[d.queue].total += d.score;
                queues[d.queue].count += 1;
            });
            const queueChartData = Object.keys(queues).map(q => ({
                name: q,
                avgScore: queues[q].count ? Math.round(queues[q].total / queues[q].count) : 0
            }));

            if (queueChartInst) queueChartInst.destroy();
            const ctxQueue = document.getElementById('queueChart').getContext('2d');
            queueChartInst = new Chart(ctxQueue, {
                type: 'bar',
                data: {
                    labels: queueChartData.map(d => d.name),
                    datasets: [{
                        label: 'Avg Score',
                        data: queueChartData.map(d => d.avgScore),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'],
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 100, display: false },
                        y: { grid: { display: false }, border: {display: false} }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderAgents(filteredParam) {
            const filtered = Array.isArray(filteredParam) ? filteredParam : getFilteredData();
            const searchTerm = document.getElementById('agent-search').value.toLowerCase();
            
            const agents = {};
            filtered.forEach(d => {
                if (!agents[d.agent]) agents[d.agent] = { name: d.agent, total: 0, count: 0, errors: 0 };
                agents[d.agent].total += d.score;
                agents[d.agent].count += 1;
                agents[d.agent].errors += d.failedAttributes?.length || 0;
            });
            
            const agentData = Object.values(agents)
                .map(a => ({ ...a, avgScore: Math.round(a.total / a.count) }))
                .filter(a => a.name.toLowerCase().includes(searchTerm))
                .sort((a, b) => b.avgScore - a.avgScore);

            const tbody = document.getElementById('agent-table-body');
            
            if (agentData.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-500">No agents found. Upload data to view performance.</td></tr>`;
                 return;
            }

            tbody.innerHTML = agentData.map(agent => {
                const initials = agent.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                let statusClass = agent.avgScore >= 90 ? 'bg-green-100 text-green-700' : (agent.avgScore >= 80 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700');
                let statusText = agent.avgScore >= 90 ? 'Excelling' : (agent.avgScore >= 80 ? 'Needs Coaching' : 'PIP Required');
                let scoreColor = agent.avgScore >= 90 ? 'text-green-600' : (agent.avgScore >= 80 ? 'text-amber-500' : 'text-red-500');
                let barColor = agent.avgScore >= 90 ? 'bg-green-500' : (agent.avgScore >= 80 ? 'bg-amber-400' : 'bg-red-500');

                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 font-medium text-slate-800 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">${initials}</div>
                            ${agent.name}
                        </td>
                        <td class="p-4 text-slate-600">${agent.count}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${scoreColor}">${agent.avgScore}%</span>
                                <div class="w-24 h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full ${barColor}" style="width: ${agent.avgScore}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-slate-600">${agent.errors}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderErrors(filtered) {
            const errors = {};
            filtered.forEach(d => {
                if (d.failedAttributes) {
                    d.failedAttributes.forEach(attr => {
                        errors[attr] = (errors[attr] || 0) + 1;
                    });
                }
            });
            const errorData = Object.entries(errors)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);

            if (errorData.length > 0) {
                document.getElementById('top-error-name').textContent = errorData[0].name;
            } else {
                document.getElementById('top-error-name').textContent = "No Data";
            }

            if(currentTab !== 'errors') return;

            if (errorChartInst) errorChartInst.destroy();
            const ctxError = document.getElementById('errorChart').getContext('2d');
            errorChartInst = new Chart(ctxError, {
                type: 'bar',
                data: {
                    labels: errorData.map(d => d.name),
                    datasets: [{
                        label: 'Error Count',
                        data: errorData.map(d => d.count),
                        backgroundColor: errorData.map((d, i) => i === 0 ? '#ef4444' : (i === 1 ? '#f97316' : '#94a3b8')),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { borderDash: [3, 3] }, border: {display: false}, beginAtZero: true },
                        x: { grid: { display: false }, border: {display: false}, ticks: { maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function render5Whys() {
            const container = document.getElementById('five-whys-container');
            
            if (fiveWhysData.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 text-slate-500">No 5 Whys data available. Sync data in the Data Setup tab to populate.</div>`;
                 return;
            }

            container.innerHTML = fiveWhysData.map(item => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 border-l-4 border-l-slate-800">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-1 bg-red-100 text-red-700 rounded uppercase tracking-wider">${item.errorAttribute}</span>
                                <span class="text-sm text-slate-500">${item.date}</span>
                                <span class="text-xs text-slate-400">ID: ${item.id}</span>
                                ${item.owner === 'AI Generated' ? `<span class="text-xs font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded flex items-center gap-1"><i data-lucide="cpu" class="w-3 h-3"></i> AI</span>` : ''}
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 mt-2">${item.problemStatement}</h3>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-lg p-5 border border-slate-200 mt-4">
                        <h4 class="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                            <i data-lucide="file-search" class="w-4 h-4 text-blue-500"></i> The 5 Whys Progression
                        </h4>
                        <div class="space-y-3 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-300 before:to-transparent">
                            
                            ${(item.whys || []).map((why, i) => `
                                <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full border border-white bg-slate-200 text-slate-600 font-bold text-sm shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 relative z-10">
                                        ${i + 1}
                                    </div>
                                    <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] p-3 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <p class="text-sm text-slate-700"><span class="font-semibold text-slate-400 mr-2">Why?</span> ${why}</p>
                                    </div>
                                </div>
                            `).join('')}

                        </div>
                        
                        <div class="mt-8 p-4 bg-red-50 border border-red-100 rounded-lg">
                            <h4 class="text-sm font-bold text-red-800 uppercase tracking-wider mb-1">Identified Root Cause</h4>
                            <p class="text-red-900 font-medium">${item.rootCause}</p>
                        </div>
                    </div>
                </div>
            `).reverse().join(''); // Reverse to show newest first
            
            lucide.createIcons({ root: container });
        }

        function renderCapa() {
            const actions = fiveWhysData.flatMap(item => [
                { id: item.id, action: item.correctiveAction, type: 'Corrective', owner: item.owner, status: item.status },
                { id: item.id, action: item.preventiveAction, type: 'Preventive', owner: item.owner, status: item.status }
            ]).filter(a => a.action); // only include if an action was actually defined

            const tbody = document.getElementById('capa-table-body');
            
            if (actions.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-slate-500">No CAPA items found.</td></tr>`;
                 return;
            }

            tbody.innerHTML = actions.reverse().map(action => {
                const typeClass = action.type === 'Corrective' ? 'bg-orange-100 text-orange-700' : 'bg-purple-100 text-purple-700';
                const statusClass = action.status === 'Completed' ? 'border-green-200 bg-green-50 text-green-700' : 'border-amber-200 bg-amber-50 text-amber-700';
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 font-medium text-slate-600 text-sm">${action.id}</td>
                        <td class="p-4 text-slate-800 text-sm">${action.action}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-semibold ${typeClass}">${action.type}</span>
                        </td>
                        <td class="p-4 text-sm font-medium text-slate-600 flex items-center gap-1">
                           ${action.owner === 'AI Generated' ? '<i data-lucide="cpu" class="w-4 h-4 text-blue-500"></i>' : ''} ${action.owner}
                        </td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold border ${statusClass}">${action.status}</span>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons({ root: tbody });
        }

        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            setupTabs();
            
            // 1. Fetch existing data from Supabase immediately on load
            await loadDataFromSupabase(); 
            
            // 2. Read saved GSheet API Config and trigger a silent background sync if it exists
            const savedUrl = localStorage.getItem('qa_gsheet_url');
            const savedApiKey = localStorage.getItem('qa_gsheet_api_key');
            const savedGeminiKey = localStorage.getItem('qa_gemini_api_key');
            
            if (savedUrl && savedApiKey) {
                document.getElementById('gsheet-url').value = savedUrl;
                document.getElementById('gsheet-api-key').value = savedApiKey;
                if (savedGeminiKey) document.getElementById('gemini-api-key').value = savedGeminiKey;
                // Run background sync silently
                syncFromGoogleSheet(true); 
            } else if (savedGeminiKey) {
                document.getElementById('gemini-api-key').value = savedGeminiKey;
            }
        });

    </script>
</body>
</html>
